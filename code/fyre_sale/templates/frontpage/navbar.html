{% load static %}

<div id="navbar">
  <div id="blue_left"></div>
  <div class="header-container">
    <a id="logo_link" href="{% url 'index' %}">
      <img id="logo" src="{% static 'img/newlogo.png' %}" alt="Fyre sale logo">
    </a>
    <div class="right-side">
      <div id="search-button"><i class="fas fa-search" id> </i></div>
      <span id="login">
        {% if user.is_authenticated %}
        <img id="user-profile-icon" src="{{MEDIA_URL}}/images/" alt="Profile picture">
        {% else %}
        <i class="fa-solid fa-user"></i>
        {% endif %}
      </span>
      {% include 'users/profilemenu.html' %}
      <br>
    </div>
  </div>
  <div id="orange_right"></div>
</div>
<div id="search-dropdown">
  <button id="filtering-button"><i class="fa-solid fa-sliders"></i> filter</button>
  <div id="search-container">
    <form id="search-form" action="{% url 'items_index' %}" method="GET">
      <select id="cat-btn">
        <option>All</option>
        {#        {% for cat in categories %}#}
        {#          <option>{{ cat.name }}</option>#}
        {#          {% for subcat in subcategories %}#}
        {#            {% if subcat.category_id == cat.id %}#}
        {#              <option>- {{ subcat.name }}</option>#}
        {#            {% endif %}#}
        {#          {% endfor %}#}
        {#        {% endfor %}#}
      </select>
      <button id="search-form-button" type="submit"><i class="fa-solid fa-magnifying-glass"></i></button>
      <input id="search-form-input" name="name" type="search" placeholder="Search" aria-label="Search">
    </form>
    <div id="search-results-list">
    </div>
  </div>
</div>

<script type="text/javascript">
  const searchButton = document.getElementById('search-button');
  const searchForm = document.getElementById('search-dropdown');
  const searchFormInput = document.getElementById('search-form-input');
  const searchDropdown = document.getElementById('cat-btn');
  const searchResults = document.getElementById('search-results-list');
  const loginButton = document.getElementById('login');
  const loginIcon = document.getElementById('user-profile-icon');
  const profileMenu = document.getElementById('profile-menu');
  const filterButton = document.getElementById('filtering-button');
  const currentWindow = window.location.pathname;
  let filterMenu;

  window.onload = () => {
    if (currentWindow === "/items/") {
      filterMenu = document.getElementById('filter-menu')
    };

    fetch('http://localhost:8000/users/api/get_image/{{ user.id }}')
      .then(response => response.json())
      .then(data => {
        const imageElem = document.getElementById('user-profile-icon');
        imageElem.src = imageElem.src + data.image;
        imageElem.style.display = 'block';
      });
  }

  if (currentWindow === "/items/") {
    searchButton.click();
  };

  searchButton.addEventListener('click', () => {
    searchForm.style.display = "flex";
  });

  document.addEventListener('click', (e) => {
    if (e.target != searchButton && e.target != searchFormInput && e.target != filterButton
    && e.target != loginButton && e.target != profileMenu && e.target != loginIcon) {
      if (currentWindow === "/items/") {
        if (e.target == filterMenu) return;
        if (e.target == searchForm) {
          filterMenu.style.display = 'none';
        }
        filterMenu.style.display = 'none';
      }
      if (e.target == searchForm) return;
      searchResults.innerHTML = '';
      searchForm.style.display = 'none';
      profileMenu.style.display = 'none';
    }
  });

  searchFormInput.addEventListener('keydown', async () => {
    const res = await fetch(`http://localhost:8000/items/api/search?name=${searchFormInput.value}`);
    const data = await res.json();
    searchResults.innerHTML = '';
    data['results'].forEach(item => {
      let newLink = document.createElement('a');
      newLink.href = `http://localhost:8000/items/${item.id}`;
      newLink.id = 'search-result';
      newLink.innerHTML = `${item.name}`
      searchResults.appendChild(newLink);
    });
  });
  // =====================================

  // ============ PROFILE MENU ===========
  loginButton.addEventListener('click', (e) => {
    profileMenu.style.display = 'block';
  });

  loginIcon.addEventListener('click', (e) => {
    profileMenu.style.display = 'block';
  });

</script>

<style>
  #filtering-button {
    display: none;
  }

  #user-profile-icon {
    object-fit: cover;
    width: 30px;
    height: 30px;
    border: none;
    border-radius: 15px;
    display: none;
  }

  .header-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 80%;
    height: 65px;
    background-color: #f08c34;
    margin: 0 0 0 0%;
  }

  #logo {
    width: 230px;
    height: 70px;
    display: inline;
  }

  #search-dropdown {
    display: none;
    width: 100%;
    animation: growDown 200ms ease-in-out forwards;
    background-color: #a5aff2;
    height: 55px;
  }

  #search-container {
    width: 60%;
    height: 45px;
    align-items: center;
    margin: auto 20%;
    justify-content: space-around;
  }

  #search-form {
    height: 100%;
    /* border-radius: 20px; */
    display: flex;
    justify-content: space-between;
    border: none;
    width: 100%;
  }

  #search-form-input {
    font-size: 20px;
    width: 100%;
    border: none;
    z-index: 1001;
  }

  #search-form-button {
    font-size: 20px;
    width: 40px;
    height: 100%;
    border: none;
    background-color: #fff;
    color: rgb(140, 140, 140);
    z-index: 1001;
  }

  #cat-btn {
    font-size: 16px;
    width: 15%;
    height: 45px;
    margin: auto 0;
    padding-left: 10px;
    border: none;
    color: rgb(140, 140, 140);
    border-right: solid #ccc 1.5px;
  }

  #search-form-button:hover {
    cursor: pointer;
  }

  .right-side {
    display: flex;
    align-items: center;
    width: 20%;
  }

  #search-button,
  #login {
    font-size: 20px;
    text-decoration: none;
    color: #ffffff;
    padding: 10px;
    width: 30px;
  }

  #search-button:hover,
  #login:hover {
    cursor: pointer;
    font-weight: 900;
  }

  #orange_right {
    width: 10%;
    background-color: #f08c34;
    height: 65px;
  }

  #blue_left {
    width: 10%;
    background-color: #4a5ee5;
    height: 65px;
  }

  #navbar {
    display: flex;
    flex-direction: row;
    z-index: 1004;
  }

  #search-results-list {
    position: absolute;
    z-index: 1000;
    margin-left: 12.7%;
    background-color: #ffffff;
    border: none;
    box-shadow: rgba(0, 0, 0, 0.35) 0px 5px 15px;
    margin-top: -1px;
  }

  #search-result {
    display: block;
    height: 20px;
    text-decoration: none;
    padding: 10px 10px 10px 40px;
  }

  @keyframes growDown {
    0% {
      transform: scaleY(0)
    }

    80% {
      transform: scaleY(1.1)
    }

    100% {
      transform: scaleY(1)
    }
  }
</style>